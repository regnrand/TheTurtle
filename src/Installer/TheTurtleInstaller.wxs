<?xml version="1.0" encoding="UTF-8"?>
<!-- These variables define the Windows Installer product version, product code and upgrade code. They   -->
<!-- will be used later on in this file.  this value should be B U I  LD_SCRIPT_MUST_REPLACE_AT_RUNTIME  (in quotes)-->
<?define Property_ProductVersion = ".*" ?>
<!-- Generate a new one for each installer, since it only uses the major upgrade approach for msi installers.
cf: http://wix.sourceforge.net/manual-wix3/major_upgrade.htm
and http://www.joyofsetup.com/2010/01/16/major-upgrades-now-easier-than-ever/
for details on why going the major upgrade route is the right answer for an msi-only install system is right.
-->
<?define Property_ProductCode = "*" ?>
<!--Don't even think of EVER changing the Property_UpgradeCode. -->
<?define Property_UpgradeCode = "C1EE5811-E382-11DE-8A39-0800200C9A66" ?>

<!-- good intro to the component vs. file thing, and why each file here is a separate component:
http://blogs.msdn.com/robmen/archive/2003/10/04/56479.aspx -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <Product Id="$(var.Property_ProductCode)" Name="The Turtle" Language="1033" Version="$(var.Property_ProductVersion)" Manufacturer="SIL" UpgradeCode="$(var.Property_UpgradeCode)">

    <!-- autogenerated package id -->
    <Package Id="*" Compressed="yes" InstallerVersion="200"/>

    <UIRef Id="WixUI_Minimal"/>
    <WixVariable Id="WixUILicenseRtf" Value="..\DistFiles\License.rtf"/>

    <!--  -->
    <MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="A newer version of [ProductName] is already installed. Setup will now exit." Schedule="afterInstallValidate"/>

    <!-- The following will set properties A[FW8INSTALLDIR] and B[FW8DEVINSTALLDIR] to the result of two different registry searches.
	If the search for B[FW8DEVINSTALLDIR] was successful, it overrides the value of A[FW8INSTALLDIR] with the value of B[FW8DEVINSTALLDIR].
	See: http://stackoverflow.com/questions/1690162/wix-set-a-property-based-on-a-condition -->
    <Property Id="FW8INSTALLDIR">
      <!-- Real users and devs have this registry entry. But, a dev machine has it set to DistFiles. -->
      <RegistrySearch Id="SearchForFW8" Root="HKLM" Key="SOFTWARE\[Manufacturer]\FieldWorks\8" Name="RootCodeDir" Type="raw"/>
    </Property>
    <Property Id="FIELDWORKSMINIMUMINSTALLEDVERSION">
      <DirectorySearch Id="FWVersion" Path="[FW8INSTALLDIR]">
        <!-- 8.0.0.41373 was the actual number the day before releasing the FW beta, but I understand one then needs to go one notch under that to find 8.0.0.41373 -->
        <FileSearch Name="FieldWorks.exe" MinVersion="8.0.0.41372"/>
      </DirectorySearch>
    </Property>
    <Property Id="DEVFW8BUILDDIR">
      <!-- Devs (only) have this registry entry. -->
      <RegistrySearch Id="SearchForFW8DevDir" Root="HKLM" Key="SOFTWARE\[Manufacturer]\FieldWorks\8" Name="FwExeDir" Type="raw"/>
    </Property>
    <Property Id="DEVFIELDWORKSMINIMUMINSTALLEDVERSION">
      <DirectorySearch Id="DevFWVersion" Path="[DEVFW8BUILDDIR]">
        <!-- 8.0.0.41373 was the actual number the day before releasing the FW beta, but I understand one then needs to go one notch under that to find 8.0.0.41373 -->
        <FileSearch Name="FieldWorks.exe" MinVersion="8.0.0.41372"/>
      </DirectorySearch>
    </Property>

    <!-- Use the dev entry, but only if set.
    <SetProperty Id="FW8INSTALLDIR" Before="SetFIELDWORKSMINIMUMINSTALLEDVERSION" Value="[DEVFW8BUILDDIR]">DEVFW8BUILDDIR</SetProperty> -->
    <SetProperty Id="FIELDWORKSMINIMUMINSTALLEDVERSION" Before="LaunchConditions" Value="[DEVFIELDWORKSMINIMUMINSTALLEDVERSION]">DEVFIELDWORKSMINIMUMINSTALLEDVERSION</SetProperty>

    <!-- 
    "from the list: Don't use Advertise="yes" Advertised shortcuts are designed to allow
users to install just the shortcut for your app, then demand-install the
rest of the app the first time the icon is run.  If this is not behavior you
are trying to support, you're better off using non-advertised shortcuts. "-->
    <Condition Message="Before [ProductName] can install, you need to install SIL's FieldWorks 8.0.0, or higher.">
      <![CDATA[Installed OR FIELDWORKSMINIMUMINSTALLEDVERSION]]>
    </Condition>

    <PropertyRef Id="NETFRAMEWORK40CLIENT"/>
    <Condition Message="Before [ProductName] can install, you need to install Microsoft's free .NET Framework 4 (Client).">
      <![CDATA[Installed OR NETFRAMEWORK40CLIENT]]>
    </Condition>

    <!--because of bug, this needs to be 1 -->
    <Property Id="ALLUSERS">1</Property>

    <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder" Name="PFiles">
        <Directory Id="SILDIR" Name="SIL">
          <Directory Id="INSTALLDIR" Name="The Turtle">
			<!-- Main bridge assemblies -->
            <Component Id="TheTurtle.exe" Guid="C1EE5812-E382-11DE-8A39-0800200C9A66">
              <File Id="TheTurtle.exe" Name="TheTurtle.exe" Source="..\output\Release\TheTurtle.exe"/>
            </Component>
            <Component Id="TheTurtle.pdb" Guid="C1EE5813-E382-11DE-8A39-0800200C9A66">
              <File Id="TheTurtle.pdb" Name="TheTurtle.pdb" KeyPath="yes" Source="..\output\Release\TheTurtle.pdb"/>
            </Component>
            <Component Id="app.config" Guid="C1EE581C-E382-11DE-8A39-0800200C9A66">
              <File Id="app.config" Name="app.config" Source="..\output\Release\TheTurtle.exe.config"/>
            </Component>
            <Component Id="RegInstallationDir" Guid="C1EDBBD7-E382-11DE-8A39-0800200C9A66">
              <RegistryKey Id="keyFLExBridge.exe" Action="createAndRemoveOnUninstall" Root="HKLM" Key="SOFTWARE\[Manufacturer]\FLEX Bridge\8">
                <RegistryValue Id="FLExBridgeInstallationDir" Type="string" Value="[INSTALLDIR]" Name="InstallationDir"/>
              </RegistryKey>
            </Component>
            <!-- Desired Chorus pdb files not in the Chorus merge module. -->
            <Component Id="Chorus.pdb" Guid="C1EDBBD4-E382-11DE-8A39-0800200C9A66">
              <File Id="Chorus.pdb" Name="Chorus.pdb" KeyPath="yes" Source="..\lib\Release\Chorus.pdb"/>
            </Component>
            <Component Id="ChorusMerge.pdb" Guid="C1EDBBD5-E382-11DE-8A39-0800200C9A66">
              <File Id="ChorusMerge.pdb" Name="ChorusMerge.pdb" KeyPath="yes" Source="..\lib\Release\ChorusMerge.pdb"/>
            </Component>
            <Component Id="ChorusHub.pdb" Guid="C1EDE2F4-E382-11DE-8A39-0800200C9A66">
               <File Id="ChorusHub.pdb" Name="ChorusHub.pdb" KeyPath="yes" Source="..\lib\Release\ChorusHub.pdb"/>
            </Component>
            <Component Id="LibChorus.pdb" Guid="C1EDBBD6-E382-11DE-8A39-0800200C9A66">
              <File Id="LibChorus.pdb" Name="LibChorus.pdb" KeyPath="yes" Source="..\lib\Release\LibChorus.pdb"/>
            </Component>
             <!-- Desired Palaso pdb files not in the Chorus merge module. -->
            <Component Id="SIL.Core.pdb" Guid="C1EDE2F8-E382-11DE-8A39-0800200C9A66">
              <File Id="SIL.Core.pdb" Name="SIL.Core.pdb" KeyPath="yes" Source="..\lib\Release\SIL.Core.pdb"/>
            </Component>
            <Component Id="SIL.Windows.Forms.pdb" Guid="C1EDE2F9-E382-11DE-8A39-0800200C9A66">
              <File Id="SIL.Windows.Forms.pdb" Name="SIL.Windows.Forms.pdb" KeyPath="yes" Source="..\lib\Release\SIL.Windows.Forms.pdb"/>
            </Component>
            <Component Id="SIL.Lift.pdb" Guid="C1EE09F3-E382-11DE-8A39-0800200C9A66">
              <File Id="SIL.Lift.pdb" Name="SIL.Lift.pdb" KeyPath="yes" Source="..\lib\Release\SIL.Lift.pdb"/>
            </Component>
            <Component Id="about.htm" Guid="68290B0A-7A61-4486-8E76-DD1C9C3F03BC">
                <File Id="about.htm" Name="about.htm" KeyPath="yes" Source="..\output\Installer\about.htm" />
            </Component>
            <Component Id="license.rtf" Guid="61288324-9979-40DF-9F86-DE66B2FA1B41">
                <File Id="license.rtf" Name="license.rtf" Source="..\DistFiles\license.rtf" />
            </Component>
            <Component Id="LogoForAbout.png" Guid="C217AC6E-CDB7-4334-9D0F-BDD53F57EA21">
                <File Id="LogoForAbout.png" Name="LogoForAbout.png" Source="..\DistFiles\LogoForAbout.png" />
            </Component>
            <Merge Id="ChorusMergeModule" Language="1033" SourceFile="..\lib\ChorusMergeModule.msm" DiskId="1"/>
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="DesktopFolder" SourceName="Desktop"/>
        <Directory Id="TheTurtleShortcutDir" Name="The Turtle">
          <Component Id="ApplicationShortcut" Guid="3D9BF2DE-4A25-11DF-9879-0800200C9A66">
            <Shortcut Id="startmenuShortcut" Name="The Turtle" Target="[!TheTurtle.exe]" WorkingDirectory="INSTALLDIR" Icon="TheTurtle.ico"/>
            <RemoveFolder Id="TheTurtleShortcutDir" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\The Turtle" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="ProductFeature" Level="1" Title="Basic Stuff">
      <ComponentRef Id="TheTurtle.exe"/>
      <ComponentRef Id="TheTurtle.pdb"/>
      <ComponentRef Id="app.config"/>

      <ComponentRef Id="ApplicationShortcut"/>
      <ComponentRef Id="RegInstallationDir"/>
      <ComponentRef Id="LibChorus.pdb"/>
      <ComponentRef Id="Chorus.pdb"/>
      <ComponentRef Id="ChorusMerge.pdb"/>
      <ComponentRef Id="ChorusHub.pdb"/>
      <ComponentRef Id="SIL.Core.pdb"/>
      <ComponentRef Id="SIL.Lift.pdb"/>
      <ComponentRef Id="SIL.Windows.Forms.pdb"/>

      <ComponentRef Id="about.htm" />
	  <ComponentRef Id="license.rtf" />
	  <ComponentRef Id="LogoForAbout.png" />

      <MergeRef Id="ChorusMergeModule"/>
      <!-- <MergeRef Id="CRT90"/>
      <MergeRef Id="CRT90Policy"/> -->
    </Feature>

    <Icon Id="TheTurtle.ico" SourceFile="..\output\Release\TheTurtle.exe"/>
    <!-- what you see in add/remove programs control panel -->
    <Property Id="ARPPRODUCTICON" Value="TheTurtle.ico"/>
  </Product>
</Wix>
